apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ebpf-xdp-deploy
  namespace: ebpf-xdp-install
  labels:
    app: ebpf-xdp-deploy
spec:
  selector:
    matchLabels:
      app: ebpf-xdp-deploy
  template:
    metadata:
      labels:
        app: ebpf-xdp-deploy
      name: ebpf-xdp-deploy
    spec:
      nodeSelector:
        kubernetes.azure.com/os-sku: Windows2022
      securityContext:
        windowsOptions:
          hostProcess: true
          runAsUserName: "NT AUTHORITY\\SYSTEM"
      hostNetwork: true
      containers:
      - name: ebpf-xdp-deploy
        image: mcr.microsoft.com/windows/servercore:ltsc2022
        command:
        - powershell.exe
        - -command
        - |
          if (!(Test-Path -Path $(tempDir))) {
              New-Item -ItemType Directory -Path $(tempDir)
            }

            $ProgressPreference = 'SilentlyContinue'
            # Download eBPF-for-Windows.
            $packageEbpfUrl = "https://github.com/microsoft/ebpf-for-windows/releases/download/Release-v0.20.0/Build-x64-native-only-NativeOnlyRelease.zip"
            Invoke-WebRequest -Uri $packageEbpfUrl -OutFile "$(tempDir)\Build-x64-native-only-NativeOnlyRelease.zip"
            Expand-Archive -Path "$(tempDir)\Build-x64-native-only-NativeOnlyRelease.zip" -DestinationPath "$(tempDir)\Build-x64-native-only-NativeOnlyRelease\msi"
            copy "$(tempDir)\Build-x64-native-only-NativeOnlyRelease\msi\Build-x64-native-only NativeOnlyRelease\*.msi" $(tempDir)

            # Download XDP-for-Windows.
            $packageXdpUrl = "https://github.com/microsoft/xdp-for-windows/releases/download/v1.1.0%2Bbed474a/bin_Release_x64.zip"
            Invoke-WebRequest -Uri $packageXdpUrl -OutFile "$(tempDir)\bin_Release_x64.zip"
            Expand-Archive -Path "$(tempDir)\bin_Release_x64.zip" -DestinationPath "$(tempDir)\bin_Release_x64"
            copy $(tempDir)\bin_Release_x64\amd64fre\xdp.cer $(tempDir)

            Invoke-WebRequest -Uri "https://github.com/microsoft/xdp-for-windows/releases/download/v1.1.0%2Bbed474a/xdp-for-windows.1.1.0.msi" -OutFile "$(tempDir)\xdp-for-windows.1.1.0.msi"

            tree /f $(tempDir)

            $installPath = ($pwd).Drive.Name + ":\ebpf-for-windows"
              Write-Output "Installing eBPF for Windows"
              Start-Process msiexec.exe -Wait -ArgumentList "/i eBPF-for-Windows.msi INSTALLFOLDER=$installPath ADDLOCAL=eBPF_Runtime_Components /qn"
              Write-Output "eBPF for Windows installed"
              sc.exe query ebpfcore
              sc.exe query netebpfext
              copy $installPath\ebpfapi.dll $(tempDir)
              dir $(tempDir)

            $installPath = ($pwd).Drive.Name + ":\xdp-for-windows"
              Write-Output "Installing XDP for Windows"
              CertUtil.exe -addstore Root xdp.cer
              CertUtil.exe -addstore TrustedPublisher xdp.cer
              Start-Process msiexec.exe -Wait -ArgumentList "/i xdp-for-windows.1.1.0.msi INSTALLFOLDER=$installPath /qn"
              sc.exe query xdp
              reg.exe add HKLM\SYSTEM\CurrentControlSet\Services\xdp\Parameters /v XdpEbpfEnabled /d 1 /t REG_DWORD /f
              net.exe stop xdp
              net.exe start xdp
              Write-Output "XDP for Windows installed"
              dir $installPath

        imagePullPolicy: IfNotPresent
        securityContext:
          privileged: true
        readinessProbe:
          exec:
            command:
            - powershell.exe
            - -command
            - |
              Test-Path "C:\wcn\scripts\ready_deploy"  # Change the command to check readiness
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 60
          successThreshold: 1
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.azure.com/mode
                operator: In
                values:
                - user
              - key: kubernetes.io/os
                operator: In
                values:
                - windows
