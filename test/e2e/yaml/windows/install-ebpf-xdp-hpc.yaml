apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ebpf-xdp-deploy
  namespace: ebpf-xdp-install
  labels:
    app: ebpf-xdp-deploy
spec:
  selector:
    matchLabels:
      app: ebpf-xdp-deploy
  template:
    metadata:
      labels:
        app: ebpf-xdp-deploy
      name: ebpf-xdp-deploy
    spec:
      nodeSelector:
        kubernetes.azure.com/os-sku: Windows2022
      securityContext:
        windowsOptions:
          hostProcess: true
          runAsUserName: "NT AUTHORITY\\SYSTEM"
      hostNetwork: true
      containers:
      - name: ebpf-xdp-deploy
        image: mcr.microsoft.com/windows/servercore:ltsc2022
        command:
        - powershell.exe
        - -command
        - |
          $binaryDir = "C:\binaries"
          if (!(Test-Path -Path $binaryDir)) {
            New-Item -ItemType Directory -Path $binaryDir
          }

          $ProgressPreference = 'SilentlyContinue'
          # Download eBPF-for-Windows.
          $packageEbpfUrl = "https://github.com/microsoft/ebpf-for-windows/releases/download/Release-v0.20.0/Build-x64-native-only-NativeOnlyRelease.zip"
          Invoke-WebRequest -Uri $packageEbpfUrl -OutFile "$(binaryDir)\Build-x64-native-only-NativeOnlyRelease.zip"
          Expand-Archive -Path "$(binaryDir)\Build-x64-native-only-NativeOnlyRelease.zip" -DestinationPath "$(binaryDir)\Build-x64-native-only-NativeOnlyRelease\msi"
          copy "$(binaryDir)\Build-x64-native-only-NativeOnlyRelease\msi\Build-x64-native-only NativeOnlyRelease\*.msi" $(binaryDir)

          Write-Host "EBPF Downloaded"

        imagePullPolicy: IfNotPresent
        securityContext:
          privileged: true
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.azure.com/mode
                operator: In
                values:
                - user
              - key: kubernetes.io/os
                operator: In
                values:
                - windows
